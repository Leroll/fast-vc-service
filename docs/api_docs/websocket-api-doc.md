# 流式语音转换服务 - WebSocket API规范

## 文档概述

本文档是流式语音转换(Voice Conversion)服务的WebSocket接口规范，适用于需要集成该服务的开发人员。文档详细说明了连接建立、消息格式、交互流程和错误处理等内容。

## 1. 服务概述

本服务提供实时的语音转换功能，允许客户端通过WebSocket发送音频流，并接收转换后的音频流，实现声音从源说话人到目标说话人的转换。

### 1.1 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 1.0 | 2025-05-27 | 初始版本 |
| 1.1 | 2025-06-15 | 增加简单协议支持，新增opus_frame_duration字段|

## 2. 交互流程

### 2.1 基本工作流程

```
客户端                                 服务器
  |                                   |
  |  --- 配置连接请求 -------------->   |
  |  <-- 就绪确认 -------------------  |  初始化模型
  |                                   |
  |  --- 音频块1 ------------------->  |  处理音频
  |  <-- 转换音频1 -----------------   |
  |                                   |
  |  --- 音频块2 ------------------->  |  处理音频
  |  <-- 转换音频2 -----------------   |
  |                                   |
  |  --- 音频块N ------------------->  |  处理音频
  |  <-- 转换音频N -----------------   |
  |                                   |
  |  --- 结束信号 ------------------>  |  完成处理
  |  <-- 完成状态 ------------------   |
  |                                   |
  |  --- 关闭连接 ------------------>  |
  |                                   |
```

### 2.2 错误处理流程

出现错误时，服务器会发送错误消息，并关闭连接。

```
客户端                                 服务器
  |                                   |
  |  --- 音频块 -------------------->  |
  |  <-- 错误消息 ------------------   |  处理出错
  |  <-- 关闭连接 ------------------   |  主动关闭WebSocket
  |                                   |  
```

## 3. 连接建立

### 3.1 WebSocket URL

```
ws://[服务器地址]/ws
```

### 3.2 连接参数

连接建立时不需要在URL中携带参数，所有配置信息将通过配置连接请求消息发送。

## 4. 消息格式

服务使用两种格式的消息:
1. **控制消息**: JSON格式，用于传递配置、状态和错误信息
2. **音频数据**: 二进制格式，用于传输原始音频数据和转换后的音频数据

### 4.1 消息类型

| 消息类型 | 方向 | 格式 | 描述 |
|---------|-----|------|-----|
| config | 客户端 -> 服务器 | JSON | 配置连接请求 |
| ready | 服务器 -> 客户端 | JSON | 就绪确认 |
| audio | 客户端 -> 服务器 | 二进制 | 输入音频数据块 |
| converted | 服务器 -> 客户端 | 二进制 | 转换后的音频数据块 |
| end | 客户端 -> 服务器 | JSON | 结束信号 |
| complete | 服务器 -> 客户端 | JSON | 完成状态 |
| error | 服务器 -> 客户端 | JSON | 错误信息 |

## 5. 详细API说明

### 5.1 配置连接请求 (config)

客户端在建立WebSocket连接后，首先发送配置消息:

```json
{
  "type": "config",
  "session_id": "sess_12345abcde",
  "api_key": "your_api_key_here",
  "sample_rate": 16000,
  "bit_depth": 16,
  "channels": 1,
  "encoding": "PCM",
  "opus_frame_duration": 20
}
```

参数说明:
- `type`: 固定为"config"
- `session_id`: 会话ID，用于标识当前连接
- `api_key`: API密钥，用于身份验证
- `sample_rate`: 采样率(Hz)
- `bit_depth`: 位深度
- `channels`: 声道数, 固定为1(单声道)
- `encoding`: 编码格式(PCM/OPUS)，默认值为"PCM"
- `opus_frame_duration`: (可选) OPUS编码帧长，单位为毫秒，默认值为20ms


### 5.2 就绪确认 (ready)

服务器初始化完成后，发送就绪确认:

```json
{
  "type": "ready",
  "session_id": "sess_12345abcde",
  "message": "Ready to process audio",
}
```

### 5.3 音频数据 (audio)

客户端发送的音频数据为二进制格式，直接作为WebSocket二进制消息发送，不封装在JSON中。每个音频块应当符合配置中指定的格式和大小。

### 5.4 转换音频 (converted)

服务器返回的转换后音频数据同样为二进制格式，直接作为WebSocket二进制消息返回，不封装在JSON中。

### 5.5 结束信号 (end)

当客户端完成所有音频发送后，发送结束信号:

```json
{
  "type": "end"
}
```

### 5.6 完成状态 (complete)

服务器完成所有处理后，发送完成状态:

```json
{
  "type": "complete",
  "stats": {
    "total_processed_ms": 5000,
    "chunks_processed": 25,
    "average_latency_ms": 120
  }
}
```

## 6. 错误处理

### 6.1 错误消息格式

服务器在检测到错误时，会发送一个错误消息，然后立即关闭连接:

```json
{
  "type": "error",
  "error_code": "ERR_CODE",
  "message": "错误描述信息",
  "details": {
    "additional_info": "附加错误信息"
  }
}
```

参数说明:
- `type`: 固定为"error"
- `error_code`: 错误代码
- `message`: 人类可读的错误描述
- `details`: (可选) 的错误详细信息

### 6.2 常见错误代码

| 错误代码 | 描述 | 处理建议 |
|---------|-----|---------|
| INVALID_CONFIG | 配置参数无效 | 检查音频格式配置 |
| AUTH_FAILED | 认证失败 | 检查API密钥 |
| INVALID_AUDIO | 音频数据格式错误 | 确保音频数据符合配置要求 |
| INTERNAL_ERROR | 服务器内部错误 | 稍后重试或联系支持团队 |
| TIMEOUT | 处理超时 | 尝试减小音频块大小或稍后重试 |

## 7. 协议适配

### 7.1 概述

为了支持不同的客户端系统，服务提供协议自动检测和适配功能。服务器会根据首条消息自动识别协议类型，并进行相应的格式转换。

### 7.2 简单协议 (Simple Protocol)

#### 7.2.1 初始化消息

简单协议客户端发送的初始化消息格式：

```json
{
  "signal": "start",
  "stream_id": "stream_12345",
  "sample_rate": 16000,
  "sample_bit": 16,
  "encoding": "PCM",
  "opus_frame_duration": 20
}
```

参数说明:
- `signal`: 固定为"start"
- `stream_id`: 流ID，用于标识当前连接
- `sample_rate`: 采样率(Hz)
- `sample_bit`: 位深度
- `encoding`: 编码格式(PCM/OPUS)，默认值为"PCM"
- `opus_frame_duration`: (可选) OPUS编码帧长，单位为毫秒，默认值为20ms

**注意**: 简单协议不需要API密钥验证，服务器不会发送ready确认消息。

#### 7.2.2 音频数据

音频数据传输格式与标准协议相同，使用WebSocket二进制消息。

#### 7.2.3 结束信号

简单协议的结束信号格式：

```json
{
  "signal": "end"
}
```

#### 7.2.4 完成状态

服务器返回给简单协议客户端的完成状态：

```json
{
  "signal": "completed"
}
```

#### 7.2.5 错误消息

服务器返回给简单协议客户端的错误消息格式：

```json
{
  "status": "failed",
  "stream_id": "stream_12345",
  "error_msg": "错误描述信息"
}
```

### 7.3 协议自动检测

服务器会根据首条消息自动检测协议类型：

| 检测条件 | 协议类型 | 描述 |
|---------|---------|------|
| `"signal": "start"` | 简单协议 | 自动转换为标准格式处理 |
| `"type": "config"` | 标准协议 | 按照标准流程处理 |
| 其他 | 标准协议 | 默认使用标准协议 |

### 7.4 简单协议交互流程

```
简单协议客户端                         服务器
  |                                   |
  |  --- 开始信号 ------------------>  |  自动检测协议
  |                                   |  初始化模型(无ready消息)
  |                                   |
  |  --- 音频块1 ------------------->  |  处理音频
  |  <-- 转换音频1 -----------------   |
  |                                   |
  |  --- 音频块N ------------------->  |  处理音频
  |  <-- 转换音频N -----------------   |
  |                                   |
  |  --- 结束信号 ------------------>  |  完成处理
  |  <-- 完成信号 ------------------   |
  |                                   |
  |  --- 关闭连接 ------------------>  |
  |                                   |
```

### 7.5 协议对比

| 特性 | 标准协议 | 简单协议 |
|-----|---------|---------|
| 初始化消息 | `type: "config"` | `signal: "start"` |
| API密钥验证 | 需要 | 不需要 |
| Ready确认 | 发送 | 不发送 |
| 结束信号 | `type: "end"` | `signal: "end"` |
| 完成消息 | `type: "complete"` | `signal: "completed"` |
| 错误格式 | 标准错误格式 | 简化错误格式 |
